<html>
<head>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> 
 <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css">
 <script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script> 
</head>

<body>

<fieldset>
<div data-role="fieldcontain">
<label for="power-flipswitch">Power:</label>
<select id="power-flipswitch" data-role="flipswitch">
<option value="off">Off</option>
<option value="on">On</option>
</select>
</div>
</fieldset>

<fieldset>
<div data-role="fieldcontain">
<label for="mute-flipswitch">Mute:</label>
<select id="mute-flipswitch" data-role="flipswitch">
<option value="off">Off</option>
<option value="on">On</option>
</select>
</div>
</fieldset>

<fieldset>
<div data-role="fieldcontain">
<label for="tone-flipswitch">Tone:</label>
<select id="tone-flipswitch" data-role="flipswitch">
<option value="off">Off</option>
<option value="on">On</option>
</select>
</div>
</fieldset>


<label>
    <label for="volume-slider">Volume:</label>
    <input name="volume-slider" id="volume-slider" data-highlight="true" min="0" max="95" value="10" type="range">
</label> 


<label for="source" class="select">Source:</label>
<select name="source" id="source">
<option value="aux1">Aux 1</option>
<option value="aux2">Aux 2</option>
<option value="coax1">Coax 1</option>
<option value="coax2">Coax 2</option>
<option value="opt1">Optical 1</option>
<option value="opt2">Optical 2</option>
<option value="tuner">Tuner</option>
<option value="phono">Phono</option>
<option value="cd">CD</option>
<option value="usb">USB</option>
</select></label> 


<label>
    <label for="treble-slider">Treble:</label>
    <input name="treble-slider" id="treble-slider" data-highlight="true" min="-10" max="10" value="0" type="range">
</label> 

<label>
    <label for="bass-slider">Bass:</label>
    <input name="bass-slider" id="bass-slider" data-highlight="true" min="-10" max="10" value="0" type="range">
</label> 

<label>
    <label for="balance-slider">Balance:</label>
    <input name="balance-slider" id="balance-slider" data-highlight="true" min="-15" max="15" value="0" type="range">
</label> 



<script type="text/javascript">
var RotelState = function() {

	this.volume = null;
	this.power = null;
	this.mute = null;
	this.inputSource = null;
	this.tone = null;
	this.bass = null;
	this.treble = null;
	this.balance = null;
	this.play_status = null;
	this.freq = null;


	this.stateChanged = function() {
		console.log(	"volume: " + this.volume + 
				", power: " + this.power + 
				", mute: " + this.mute + 
				", inputSource: " + this.inputSource + 
				", tone: " + this.tone + 
				", bass: " + this.bass + 
				", treble: " + this.treble + 
				", balance: " + this.balance +
				", freq: " + this.freq + 
				", play_status: " + this.play_status)
		
		$("#power-flipswitch").val(this.power).flipswitch('refresh');
		$("#mute-flipswitch").val(this.mute).flipswitch('refresh');
		$("#volume-slider").val(this.volume).slider('refresh');
		$("#source").val(this.inputSource).selectmenu('refresh');
		//$("#bass-slider").val(Number(this.bass)).slider('refresh');
		$("#treble-slider").val(Number(this.treble)).slider('refresh');

	}
}

var RotelClient = function() {
	var rotelState = new RotelState();
	var self = this;
	this.webSocket = new WebSocket('ws://localhost:8989/ws');
	this.webSocket.onopen = function() {
		self.webSocket.send('open /dev/ttyUSB0 115200');
	};

	this.webSocket.onerror = function(error) {
		console.log("error: " + error);	
	};

	this.webSocket.onmessage = function(e) {
		parseEvent(e, rotelState);
	};

	this.sourceCdEvent =  function() { return this.createActionEvent('cd'); }
	this.sourceUsbEvent =  function() { return this.createActionEvent('usb'); }
	this.sourceCoax1Event =  function() { return this.createActionEvent('coax1'); }
	this.sourceCoax2Event =  function() { return this.createActionEvent('coax2'); }
	this.sourceOpt1Event =  function() { return this.createActionEvent('opt1'); }
	this.sourceOpt2Event =  function() { return this.createActionEvent('opt2'); }
	this.sourceAux1Event =  function() { return this.createActionEvent('aux1'); }
	this.sourceAux2Event =  function() { return this.createActionEvent('aux2'); }
	this.sourceTunerEvent =  function() { return this.createActionEvent('tuner'); }
	this.sourcePhonoEvent =  function() { return this.createActionEvent('phono'); }

	this.toggleMuteEvent = function() { return this.createActionEvent('mute'); }
	this.muteOnEvent = function() { return this.createActionEvent('mute_on'); }
	this.muteOffEvent = function() { return this.createActionEvent('mute_off'); }
	this.muteSetEvent = function(v) { return this.createActionEvent('mute_' + v); }
	this.toneOnEvent = function() { return this.createActionEvent('tone_on'); }
	this.toneOffEvent = function() { return this.createActionEvent('tone_off'); }
	this.toneSetEvent = function(v) { return this.createActionEvent('tone_' + v); }
	this.togglePowerEvent = function() { return this.createActionEvent('power_toggle'); }
	this.powerOnEvent = function() { return this.createActionEvent('power_on'); }
	this.powerOffEvent = function() { return this.createActionEvent('power_off'); }
	this.powerSetEvent = function(v) { return this.createActionEvent('power_' + v); }
	this.volumeSetEvent = function(v) { return this.createActionEvent('volume_' + v); }
	this.bassSetEvent = function(v) { return this.createActionEvent('bass_' + v); }
	this.bassUpEvent = function() { return this.createActionEvent('bass_up'); }
	this.bassDownEvent = function() { return this.createActionEvent('bass_down'); }
	this.trebleSetEvent = function(v) { return this.createActionEvent('treble_' + v); }
	this.balanceSetEvent = function(v) { return this.createActionEvent('balance_' + v); }
	this.volumeDownEvent = function() { return this.createActionEvent('volume_down'); }
	this.getCurrentPowerEvent = function() { return this.createActionEvent('get_current_power'); }
	this.getCurrentSourceEvent = function() { return this.createActionEvent('get_current_source'); }
	this.getToneEvent = function() { return this.createActionEvent('get_tone'); }
	this.getBassEvent = function() { return this.createActionEvent('get_bass'); }
	this.getTrebleEvent = function() { return this.createActionEvent('get_treble'); }
	this.getBalanceEvent = function() { return this.createActionEvent('get_balance'); }
	this.getCurrentFreqEvent = function() { return this.createActionEvent('get_current_freq'); }
	this.getVolumeEvent = function() { return this.createActionEvent('get_volume'); }

	this.createActionEvent = function(action) {
		return 'sendjson {"P":"/dev/ttyUSB0","Data":[{"D":"'+action+'!"}]}';
	};

	var parseEvent = function(evt, rotelState) {
		console.log("server: " + evt.data);
		var response = JSON.parse(evt.data);
		console.log("response:" + response);
		if (response && response.D) {
			typeAndValue = /([a-z]+)\=([a-z0-9]+)\!/gi.exec(response.D);
			console.log("typeAndValue: " + typeAndValue);
			if (typeAndValue) {
				var type = typeAndValue[1];
				var value = typeAndValue[2];
				switch (type) {
					case "volume":
						rotelState.volume = value;
						break;
					case "power":
						rotelState.power = value;
						break;
					case "mute":
						rotelState.mute = value;
						break;
					case "source":
						rotelState.inputSource = value;
						break;
					case "tone":
						rotelState.tone = value;
						break;
					case "bass":
						rotelState.bass = value;
						break;
					case "treble":
						rotelState.treble = value;
						break;
					case "balance":
						rotelState.balance = value;
						break;
					case "freq":
						rotelState.freq = value;
						break;
					case "play_status":
						rotelState.play_status = value;
						break;
				}
				rotelState.stateChanged();
			}
		}
	}

	var discard = function() {
		webSocket.close();
	}

};


$(document).ready(function(){
	var rotelClient = new RotelClient();
source
    	$("#source").on("change", function() {
		var a = rotelClient.createActionEvent($("#source").val());
		rotelClient.webSocket.send(a);
	} );

    	$("#mute-flipswitch").on("change", function() {
		var a = rotelClient.muteSetEvent($("#mute-flipswitch").val());
		rotelClient.webSocket.send(a);
	} );

    	$("#power-flipswitch").on("change", function() {
		var a = rotelClient.powerSetEvent($("#power-flipswitch").val());
		rotelClient.webSocket.send(a);
	} );

    	$("#tone-flipswitch").on("change", function() {
		var a = rotelClient.toneSetEvent($("#tone-flipswitch").val());
		rotelClient.webSocket.send(a);
	} );

    	$("#volume-slider").on("change", function() {
		var a = rotelClient.volumeSetEvent($("#volume-slider").val());
		rotelClient.webSocket.send(a);
	} );

    	$("#bass-slider").on("change", function() {
		var v = $("#bass-slider").val();
		var a;
		if (v < 0) {
			a = rotelClient.bassSetEvent(v + '');
		} else if (v == 0) {
			a = rotelClient.bassSetEvent('000');
		} else if (v > 0) {
			a = rotelClient.bassSetEvent('+' + v);
		}
		a = rotelClient.bassUpEvent();
		rotelClient.webSocket.send(a);
	} );
    	$("#treble-slider").on("change", function() {
		var a = rotelClient.volumeSetEvent($("#treble-slider").val());
		rotelClient.webSocket.send(a);
	} );
});

$(window).on('beforeunload', function() {rotelClient.discard();} );




</script>
</body>
</html>
